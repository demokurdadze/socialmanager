{% extends "base_generic.html" %}
{% load i18n static humanize %}

{% block title %}
    {% blocktrans with sender=conversation.sender_name page_name=page.page_name %}
    Chat: {{ sender }} on {{ page_name }}
    {% endblocktrans %}
{% endblock title %}

{% block header_title %}
    <div class="conversation-header-title" style="display: flex; align-items: center; gap: 0.5rem;">
         <i class="fab fa-facebook-square" style="font-size: 1.2em; color: #1877F2;" aria-hidden="true"></i>
         <span>
            {% blocktrans with sender=conversation.sender_name page_name=page.page_name %}
            {{ sender }} <span style="font-weight: normal; color: var(--muted-foreground); font-size: 0.9em;">on {{ page_name }}</span>
            {% endblocktrans %}
         </span>
    </div>
{% endblock header_title %}

{% block content %}
<div class="chat-detail-layout">
    <div class="card chat-window">
        <div class="card-header chat-header">
            <h3 class="card-title visually-hidden">{% trans "Messages" %}</h3>
            <div class="chat-actions">
                 {# --- Delete Form URL Updated --- #}
                <form method="post" action="{% url 'delete_conversation' connected_page_pk=page.pk sender_id=conversation.sender_id %}" class="delete-conversation-form" onsubmit="return confirm('{% trans "Are you sure you want to delete this chat history from the system? This cannot be undone." %}');">
                    {% csrf_token %}
                    <button type="submit" class="button button-destructive button-sm" title="{% trans 'Delete History' %}">
                         <i class="fas fa-trash-alt"></i> {% trans "Delete History" %}
                    </button>
                </form>
                 <a href="{% url 'inbox' %}" class="button button-secondary button-sm">{% trans "Back to Inbox" %}</a>
            </div>
        </div>

        {# Message Display Area - Adjusted for better timestamp/manual display #}
        <div class="card-content chat-messages" id="chatbox">
            {% for message in conversation.messages %}
                <div class="message
                    {% if message.role == 'user' %}user-message{% endif %}
                    {% if message.role == 'assistant' and not message.manual %}ai-message{% endif %}
                    {% if message.role == 'assistant' and message.manual %}manual-message{% endif %}
                    {% if message.role == 'system' %}system-message{% endif %}">

                    <div class="message-body">
                        {% if message.role == 'user' %}<strong>{% trans "User" %}:</strong>{% endif %}
                        {% if message.role == 'assistant' and not message.manual %}<strong>{% trans "AI" %}:</strong>{% endif %}
                        {% if message.role == 'assistant' and message.manual %}<strong>{% trans "You (Manual)" %}:</strong>{% endif %}
                         {% if message.role == 'system' %}<strong>{% trans "System" %}:</strong>{% endif %} {# Usually hidden via CSS #}

                        {# Use linebreaksbr for content #}
                         <span class="message-text">{% autoescape off %}{{ message.content|linebreaksbr }}{% endautoescape %}</span>
                    </div>

                    {% if message.timestamp %}
                        <div class="message-meta">
                            <span class="message-timestamp" title="{{ message.timestamp|date:'Y-m-d H:i:s T' }}">
                               {# {{ message.timestamp|date:"M d, H:i" }} #}
                               {{ message.timestamp|naturaltime }}
                            </span>
                            {% if message.manual %}<span class="manual-indicator">({% trans "Manual" %})</span>{% endif %}
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p class="text-center muted">{% trans "No messages in this conversation yet." %}</p>
            {% endfor %}
        </div>

         {# Manual Reply Input Area #}
         <div class="card-footer chat-input-area">
            {% if page.page_access_token and page.is_active %}
                {# --- Reply Form URL Updated --- #}
                <form method="post" action="{% url 'send_manual_reply' connected_page_pk=page.pk sender_id=conversation.sender_id %}" class="manual-reply-form">
                    {% csrf_token %}
                    {{ reply_form.message }} {# Uses ManualReplyForm #}
                    <button type="submit" class="button button-primary" title="{% trans 'Send Manual Reply' %}">
                        <i class="fas fa-paper-plane"></i>
                        <span class="visually-hidden">{% trans "Send Reply" %}</span>
                    </button>
                </form>
            {% elif not page.is_active %}
                 <p class="muted text-center">{% trans "This page connection is inactive. Activate it to send replies." %}</p>
            {% else %}
                <p class="muted text-center">{% trans "Cannot send reply: Page token missing or connection issue." %}</p>
            {% endif %}
         </div>
    </div>
</div>

<style>
    .chat-detail-layout { /* max-width: 800px; margin: auto; */ }
    .chat-window { display: flex; flex-direction: column; height: calc(100vh - 140px); /* Adjust as needed */ } /* Make chat window tall */
    .chat-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .chat-actions { display: flex; gap: 0.5rem; align-items: center; }
    .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem 1.5rem; background-color: var(--secondary); display: flex; flex-direction: column; gap: 1rem;}
    .chat-input-area { flex-shrink: 0; border-top: 1px solid var(--border); padding: 0.75rem 1rem; }
    .manual-reply-form { display: flex; gap: 0.5rem; align-items: flex-end; }
    .manual-reply-form textarea { flex-grow: 1; }

    .message { display: flex; flex-direction: column; max-width: 75%; padding: 0.75rem 1rem; border-radius: var(--radius); line-height: 1.4; word-wrap: break-word; font-size: 0.9rem; position: relative;}
    .message strong { font-weight: 600; margin-right: 0.5em; }
    .message-body { margin-bottom: 0.25rem; }
    .message-text {}
    .message-meta { font-size: 0.75rem; color: var(--muted-foreground); text-align: right; margin-top: 0.3rem; }
    .message-timestamp {}
    .manual-indicator { margin-left: 0.5em; font-style: italic; }

    .user-message { align-self: flex-end; background-color: var(--primary); color: var(--primary-foreground); border-bottom-right-radius: 0; }
    .user-message .message-meta { color: rgba(255, 255, 255, 0.8); }

    .ai-message { align-self: flex-start; background-color: var(--background); color: var(--foreground); border: 1px solid var(--border); border-bottom-left-radius: 0; }
    .manual-message { align-self: flex-end; /* Manual replies align right like user */ background-color: #e0e7ff; /* Lighter Indigo */ color: var(--foreground); border: 1px solid #c7d2fe; border-bottom-right-radius: 0; }
    .dark .manual-message { background-color: #3730a3; /* Darker Indigo */ color: var(--primary-foreground); border-color: #4f46e5; }

    .system-message { display: none; } /* Hide system messages in detail view */

    /* Visually hidden class */
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chatbox = document.getElementById('chatbox');
    if (chatbox) {
      chatbox.scrollTop = chatbox.scrollHeight; // Scroll to bottom on load

       // Auto-resize textarea
       const textarea = document.querySelector('.manual-reply-form textarea');
       if (textarea) {
           function autoResize() {
              textarea.style.height = 'auto'; // Reset height
              // Set height up to max (e.g., 150px), accounting for scrollHeight and box-sizing
              const maxHeight = 150;
              const newHeight = Math.min(textarea.scrollHeight, maxHeight);
              textarea.style.height = newHeight + 'px';
           }
           textarea.addEventListener('input', autoResize);
           autoResize(); // Initial resize
       }
    }
  });
</script>
{% endblock content %}