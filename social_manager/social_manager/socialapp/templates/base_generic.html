<!DOCTYPE html>
{% load i18n static %} {# Ensure i18n is loaded #}
<html lang="{{ request.LANGUAGE_CODE|default:"en" }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}{% trans "Social Manager" %}{% endblock %}</title>
  {% load static %}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* --- Base Variables & Reset --- */
    :root {
      --background: #ffffff; /* White */
      --foreground: #0f172a; /* Slate 900 */
      --card: #ffffff; /* White */
      --card-foreground: #0f172a; /* Slate 900 */
      --popover: #ffffff; /* White */
      --popover-foreground: #0f172a; /* Slate 900 */
      --primary: #6366f1; /* Indigo 500 */
      --primary-foreground: #ffffff; /* White */
      --primary-hover: #4f46e5; /* Indigo 600 */
      --secondary: #f1f5f9; /* Slate 100 */
      --secondary-foreground: #0f172a; /* Slate 900 */
      --secondary-hover: #e2e8f0; /* Slate 200 */
      --muted: #f1f5f9; /* Slate 100 */
      --muted-foreground: #64748b; /* Slate 500 */
      --accent: #f1f5f9; /* Slate 100 */
      --accent-foreground: #0f172a; /* Slate 900 */
      --destructive: #ef4444; /* Red 500 */
      --destructive-foreground: #ffffff; /* White */
      --border: #e2e8f0; /* Slate 200 */
      --input: #e2e8f0; /* Slate 200 */
      --ring: #a5b4fc; /* Indigo 300 */
      --radius: 0.5rem;
      --font-sans: 'Inter', sans-serif;
    }

    .dark {
      --background: #020817; /* Slate 950 */
      --foreground: #f8fafc; /* Slate 50 */
      --card: #0f172a; /* Slate 900 */
      --card-foreground: #f8fafc; /* Slate 50 */
      --popover: #0f172a; /* Slate 900 */
      --popover-foreground: #f8fafc; /* Slate 50 */
      --primary: #818cf8; /* Indigo 400 */
      --primary-foreground: #0f172a; /* Slate 900 */
      --primary-hover: #a5b4fc; /* Indigo 300 */
      --secondary: #1e293b; /* Slate 800 */
      --secondary-foreground: #f8fafc; /* Slate 50 */
      --secondary-hover: #334155; /* Slate 700 */
      --muted: #1e293b; /* Slate 800 */
      --muted-foreground: #94a3b8; /* Slate 400 */
      --accent: #1e293b; /* Slate 800 */
      --accent-foreground: #f8fafc; /* Slate 50 */
      --destructive: #f87171; /* Red 400 */
      --destructive-foreground: #0f172a; /* Slate 900 */
      --border: #334155; /* Slate 700 */
      --input: #334155; /* Slate 700 */
      --ring: #4f46e5; /* Indigo 600 */
    }

    @media (prefers-color-scheme: dark) {
      /* Optional: Default to OS preference */
      /* :root { @apply dark; } */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; border: 0 solid var(--border); }
    html { scroll-behavior: smooth; font-family: var(--font-sans); }
    body { background-color: var(--background); color: var(--foreground); min-height: 100vh; overflow-x: hidden; }
    a { color: var(--primary); text-decoration: none; transition: color 0.2s ease-in-out; }
    a:hover { color: var(--primary-hover); text-decoration: underline; }
    .layout { display: flex; min-height: 100vh; }

    /* --- Sidebar --- */
    .sidebar { width: 260px; background-color: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.3s ease, width 0.3s ease; position: fixed; top: 0; left: 0; height: 100vh; z-index: 50; color: var(--card-foreground); }
    .sidebar-header { display: flex; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); min-height: 60px; }
    .logo { font-weight: 700; font-size: 1.125rem; color: var(--foreground); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; }
    .logo:hover { text-decoration: none; }
    .logo-icon { height: 2rem; width: 2rem; background-color: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--primary-foreground); font-weight: bold; font-size: 0.875rem; }
    .nav-items { flex: 1; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 0.75rem; border-radius: var(--radius); color: var(--muted-foreground); text-decoration: none; transition: all 0.2s ease; font-weight: 500; font-size: 0.875rem; position: relative; overflow: hidden; }
    .nav-item:hover { color: var(--foreground); background-color: var(--secondary); text-decoration: none; }
    .nav-item.active { color: var(--primary); background-color: var(--secondary); font-weight: 600; }
    .nav-item .icon { width: 18px; height: 18px; stroke-width: 2; stroke: currentColor; }
    .nav-status-indicator { display: inline-block; padding: 0.125rem 0.5rem; font-size: 0.75rem; font-weight: 500; border-radius: 9999px; margin-left: auto; }
    .nav-status-ok { background-color: rgba(16, 185, 129, 0.1); color: #10b981; }
    .nav-status-warning { background-color: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .connect-link { margin-left: auto; padding: 0.25rem 0.625rem; font-size: 0.75rem; font-weight: 500; border: 1px solid var(--primary); border-radius: var(--radius); color: var(--primary); transition: all 0.2s ease; }
    .connect-link:hover { background-color: var(--primary); color: var(--primary-foreground); text-decoration: none; }
    .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border); }
    .user-profile { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: var(--radius); transition: background-color 0.2s; cursor: pointer; }
    .user-profile:hover { background-color: var(--secondary); }
    .avatar { height: 2.5rem; width: 2.5rem; border-radius: 9999px; background-color: var(--muted); display: flex; align-items: center; justify-content: center; font-weight: 500; color: var(--muted-foreground); overflow: hidden; font-size: 0.875rem; }
    .user-info { display: flex; flex-direction: column; flex: 1; line-height: 1.2; }
    .user-name { font-weight: 500; color: var(--foreground); font-size: 0.875rem; }
    .user-email { color: var(--muted-foreground); font-size: 0.75rem; }
    .logout-button { background: none; border: none; cursor: pointer; color: var(--muted-foreground); padding: 0.25rem; border-radius: var(--radius); transition: color 0.2s, background-color 0.2s; }
    .logout-button:hover { color: var(--destructive); background-color: var(--secondary); }
    .logout-button svg { width: 18px; height: 18px; }

    /* --- Main Content Wrapper (ADJUSTED FOR CONDITIONAL SIDEBAR) --- */
    .main-content-wrapper {
        flex: 1;
        margin-left: 0; /* Default: No margin */
        width: 100%; /* Default: Full width */
        transition: margin-left 0.3s ease, width 0.3s ease;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    /* Apply margin only when sidebar exists (desktop) */
    .has-sidebar .main-content-wrapper {
        margin-left: 260px; /* Width of the sidebar */
        width: calc(100% - 260px);
    }

    /* --- Header (ADJUSTED FOR CONDITIONAL SIDEBAR) --- */
    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem; /* Default padding (no sidebar or mobile view with sidebar) */
        min-height: 60px;
        border-bottom: 1px solid var(--border);
        background-color: var(--background);
        position: sticky;
        top: 0;
        z-index: 40;
    }
    /* Add left padding for mobile toggle space only if sidebar exists */
    .has-sidebar .main-header {
        padding-left: 3.5rem;
    }
    /* Restore normal padding on desktop */
    @media (min-width: 769px) {
        .main-header {
            padding: 0 2rem; /* Desktop padding (no sidebar) */
        }
        .has-sidebar .main-header {
            padding-left: 2rem; /* Desktop padding (with sidebar) - override mobile padding */
        }
    }

    .page-title { font-size: 1.25rem; font-weight: 600; color: var(--foreground); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .header-controls { display: flex; align-items: center; gap: 0.75rem; }

    /* --- Language Switcher --- */
    .language-switcher { position: relative; }
    #language-toggle-btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.35rem; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background-color: var(--background); color: var(--foreground); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; white-space: nowrap; }
    #language-toggle-btn:hover { background-color: var(--secondary); border-color: var(--input); }
    #language-toggle-btn:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }
    #language-toggle-btn svg { width: 0.75rem; height: 0.75rem; stroke: currentColor; stroke-width: 2; transition: transform 0.2s ease; }
    #language-toggle-btn.open svg { transform: rotate(180deg); }
    #language-dropdown { position: absolute; top: calc(100% + 0.5rem); right: 0; min-width: 150px; /* Wider */ background-color: var(--popover); color: var(--popover-foreground); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 55; /* Above sidebar */ padding: 0.5rem 0; list-style: none; margin: 0; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease; }
    .dark #language-dropdown { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    #language-dropdown.visible { opacity: 1; visibility: visible; transform: translateY(0); }
    .language-dropdown-item button { display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; background: none; border: none; color: var(--popover-foreground); font-size: 0.875rem; cursor: pointer; white-space: nowrap; transition: background-color 0.15s ease; }
    .language-dropdown-item button:hover, .language-dropdown-item button:focus { background-color: var(--accent); color: var(--accent-foreground); outline: none; }
    .language-dropdown-item button.active { font-weight: 600; color: var(--primary); }
    .language-dropdown-item button.active:hover { background-color: var(--accent); }
    .language-switcher form { /* Hidden form */ position: absolute; opacity: 0; pointer-events: none; width: 1px; height: 1px; overflow: hidden; }

    /* --- Theme Toggle --- */
    #theme-toggle { padding: 0.5rem; line-height: 0; border: 1px solid var(--border); background-color: transparent; color: var(--muted-foreground); }
    #theme-toggle:hover { background-color: var(--secondary); color: var(--foreground); }
    #theme-toggle svg { width: 1.125rem; height: 1.125rem; }

    /* --- Main Content Area --- */
     .main-content { flex-grow: 1; padding: 2rem; background-color: var(--secondary); overflow-y: auto; }
     @media (max-width: 768px) { .main-content { padding: 1rem; } }

    /* --- Card --- */
    .card { background-color: var(--card); color: var(--card-foreground); border-radius: var(--radius); border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1.5rem; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05), 0 6px 6px rgba(0,0,0,0.07); border-color: var(--ring); }
    .dark .card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.15), 0 6px 6px rgba(0,0,0,0.1); }
    .card-header { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .card-header:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem; }
    .card-description { font-size: 0.875rem; color: var(--muted-foreground); }
    .card-content { font-size: 0.875rem; color: var(--foreground); padding-top: 1rem; }
    .card-header + .card-content { padding-top: 1rem; }
    .card-footer { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.875rem; color: var(--muted-foreground); display: flex; gap: 0.5rem; align-items: center; }
    .card-content + .card-footer { margin-top: 1rem; }

    /* --- Button --- */
    .button { display: inline-flex; align-items: center; justify-content: center; border-radius: var(--radius); font-size: 0.875rem; font-weight: 500; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; line-height: 1.25; text-decoration: none; white-space: nowrap; }
    .button-sm { font-size: 0.75rem; padding: 0.25rem 0.75rem; }
    .button:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }
    .button:disabled { opacity: 0.5; cursor: not-allowed; }
    .button:active:not(:disabled) { transform: translateY(1px); }
    .button:hover { text-decoration: none; }
    .button-primary { background-color: var(--primary); color: var(--primary-foreground); border-color: var(--primary); }
    .button-primary:hover:not(:disabled) { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    .button-secondary { background-color: var(--secondary); color: var(--secondary-foreground); border-color: var(--border); }
    .button-secondary:hover:not(:disabled) { background-color: var(--secondary-hover); border-color: var(--input); }
    .button-destructive { background-color: var(--destructive); color: var(--destructive-foreground); border-color: var(--destructive); }
    .button-destructive:hover:not(:disabled) { background-color: rgba(239, 68, 68, 0.9); border-color: rgba(239, 68, 68, 0.9); }
    .dark .button-destructive:hover:not(:disabled) { background-color: rgba(248, 113, 113, 0.9); border-color: rgba(248, 113, 113, 0.9); }
    .button-ghost { background-color: transparent; color: var(--primary); border-color: transparent; }
    .button-ghost:hover:not(:disabled) { background-color: var(--accent); }
    .button-link { background-color: transparent; color: var(--primary); text-decoration: none; padding: 0; height: auto; justify-content: flex-start; }
    .button-link:hover:not(:disabled) { text-decoration: underline; text-underline-offset: 4px; }

    /* --- Forms --- */
    .form-card { max-width: 450px; margin: 2rem auto; background-color: var(--card); color: var(--card-foreground); border-radius: var(--radius); border: 1px solid var(--border); padding: 2rem; animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
     @media (max-width: 768px) { .form-card { margin: 1rem; padding: 1.5rem; } }
    .form-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; text-align: center; }
    .styled-form p { margin-bottom: 1rem; }
    .styled-form p:has(input[type=checkbox]) { display: flex; align-items: center; gap: 0.5rem; }
    .styled-form p:has(input[type=checkbox]) label { margin-bottom: 0; }
    .styled-form p input[type=checkbox] { width: auto; accent-color: var(--primary); }
    .styled-form label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--foreground); }
    .form-input, .styled-form input[type="text"], .styled-form input[type="email"], .styled-form input[type="password"], .styled-form input[type="number"], .styled-form select, .styled-form textarea { display: block; width: 100%; padding: 0.625rem 0.75rem; border-radius: var(--radius); border: 1px solid var(--input); background-color: var(--background); color: var(--foreground); font-family: inherit; font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s; }
    .form-input:focus, .styled-form input:focus, .styled-form select:focus, .styled-form textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
    textarea.form-input, .styled-form textarea { min-height: 150px; resize: vertical; } /* Default height for form textarea */
    #id_system_prompt { min-height: 250px; } /* Specific taller height for system prompt */
    .styled-form .helptext, .styled-form .form-text { font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; display: block; }
    .styled-form ul.errorlist { list-style: none; padding: 0; margin: 0.5rem 0 0 0; color: var(--destructive); font-size: 0.75rem; }
    .styled-form ul.errorlist li { margin-bottom: 0.25rem; }
    .styled-form .errorlist ~ input, .styled-form .errorlist ~ textarea, .styled-form .errorlist ~ select { border-color: var(--destructive) !important; }
    .styled-form .errorlist ~ input:focus, .styled-form .errorlist ~ textarea:focus, .styled-form .errorlist ~ select:focus { box-shadow: 0 0 0 1px var(--destructive) !important; }
    .btn-submit { width: 100%; margin-top: 1rem; }
    .btn-submit:hover:not(:disabled) { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    .form-links { margin-top: 1.5rem; text-align: center; font-size: 0.875rem; color: var(--muted-foreground); }
    .form-links p { margin-bottom: 0.5rem; }
    .form-links a { font-weight: 500; color: var(--primary); }
    .form-links a:hover { text-decoration: underline; }

    /* --- Social Login --- */
    .socialaccount_ballot { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
    .socialaccount-title { text-align: center; font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 1rem; position: relative; display: flex; align-items: center; gap: 0.75rem; }
    .socialaccount-title::before, .socialaccount-title::after { content: ""; flex-grow: 1; height: 1px; background-color: var(--border); }
    .socialaccount_providers { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
    .socialaccount_provider { display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 0.625rem 1rem; border-radius: var(--radius); border: 1px solid var(--border); background-color: var(--background); color: var(--foreground); font-size: 0.875rem; font-weight: 500; transition: all 0.2s ease; text-decoration: none; cursor: pointer; }
    .socialaccount_provider:hover { background-color: var(--secondary); border-color: var(--input); text-decoration: none; }
    .socialaccount_provider .fab, .socialaccount_provider .fas, .socialaccount_provider svg { font-size: 1.125rem; width: 1.125rem; height: 1.125rem; }
    .socialaccount_provider span { line-height: 1; }
    .socialaccount_provider.facebook { color: #1877F2; }
    .socialaccount_provider.google .fa-google { color: #4285F4; }
    .dark .socialaccount_provider.github { color: var(--foreground); }

    /* --- Chat UI --- */
    .chat-container { display: flex; flex-direction: column; height: calc(100vh - 260px); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; background-color: var(--card); }
     @media (max-width: 768px) { .chat-container { height: calc(100vh - 180px); } }
    .system-prompt-info { padding: 1rem; background-color: var(--secondary); border-bottom: 1px solid var(--border); font-size: 0.875rem; color: var(--muted-foreground); flex-shrink: 0; }
    .system-prompt-info strong { color: var(--foreground); display: block; margin-bottom: 0.5rem; }
    .system-prompt-info pre { margin-top: 0.5rem; padding: 0.75rem; background-color: var(--background); border-radius: var(--radius); border: 1px solid var(--border); overflow-x: auto; font-family: monospace; font-size: 0.8rem; max-height: 100px; color: var(--foreground); white-space: pre-wrap; word-break: break-word; }
    .system-prompt-info a { display: inline-block; margin-top: 0.75rem; color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.8rem; }
    .system-prompt-info a:hover { text-decoration: underline; }
    .chatbox { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; background-color: var(--background); }
    .message { max-width: 75%; padding: 0.75rem 1rem; border-radius: var(--radius); line-height: 1.4; animation: messageSlideIn 0.3s ease-out forwards; word-wrap: break-word; opacity: 0; font-size: 0.875rem; }
    .message strong { display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.75rem; }
    .message span { display: block; }
    @keyframes messageSlideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .user-message { align-self: flex-end; background-color: var(--primary); color: var(--primary-foreground); border-bottom-right-radius: 0; }
    .user-message strong { color: rgba(255, 255, 255, 0.8); }
    .ai-message { align-self: flex-start; background-color: var(--secondary); color: var(--secondary-foreground); border: 1px solid var(--border); border-bottom-left-radius: 0; }
    .ai-message strong { color: var(--foreground); }
    .system-message { align-self: center; background-color: var(--muted); color: var(--muted-foreground); font-style: italic; max-width: 90%; text-align: center; font-size: 0.75rem; padding: 0.5rem 1rem; }
    .system-message strong { display: none; }
    #input-area { display: flex; padding: 1rem; border-top: 1px solid var(--border); background-color: var(--secondary); gap: 0.5rem; flex-shrink: 0; }
    #message-input { flex: 1; padding: 0.625rem 0.75rem; border-radius: var(--radius); border: 1px solid var(--input); background-color: var(--background); color: var(--foreground); font-family: inherit; resize: none; outline: none; transition: border-color 0.2s, box-shadow 0.2s; font-size: 0.875rem; }
    #message-input:focus { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
    #send-button { padding: 0 1rem; } /* Uses .button .button-primary */
    #error-display { padding: 0.75rem 1rem; background-color: var(--destructive); color: var(--destructive-foreground); border-bottom: 1px solid var(--border); font-size: 0.875rem; font-weight: 500; text-align: center; }
    .dark #error-display { color: var(--foreground); }

    /* --- Alert --- */
    .alert { padding: 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: var(--radius); }
    .alert-danger { color: #991b1b; background-color: #fee2e2; border-color: #fca5a5; }
    .dark .alert-danger { color: #fecaca; background-color: #3f1212; border-color: #ef4444; }
    .alert strong { font-weight: 600; }

    /* --- Utility Classes --- */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-1 { margin-top: 0.25rem; } .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.25rem; } .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; }
    .w-full { width: 100%; } .font-mono { font-family: monospace; } .text-xs { font-size: 0.75rem; }

    /* --- Responsive & Mobile Menu (ADJUSTED FOR CONDITIONAL SIDEBAR) --- */
    .mobile-menu-toggle { display: none; /* Hidden by default, shown via media query below if needed */ background: none; border: none; color: var(--foreground); cursor: pointer; padding: 0.5rem; position: fixed; top: calc((60px - 36px) / 2); left: 1rem; z-index: 100; width: 36px; height: 36px; border-radius: var(--radius); transition: background-color 0.2s; }
    .mobile-menu-toggle:hover { background-color: var(--secondary); }
    .mobile-menu-toggle .bar { display: block; width: 20px; height: 2px; background-color: var(--foreground); border-radius: 1px; transition: all 0.3s ease-in-out; margin: 4px auto; }
    .mobile-menu-toggle.active .bar:nth-child(1) { transform: translateY(6px) rotate(45deg); }
    .mobile-menu-toggle.active .bar:nth-child(2) { opacity: 0; }
    .mobile-menu-toggle.active .bar:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 45; display: none; opacity: 0; transition: opacity 0.3s ease; }
    .overlay.active { display: block; opacity: 1; }

    @media (max-width: 768px) {
        /* Only show toggle and apply mobile sidebar behavior IF sidebar exists */
        .has-sidebar .mobile-menu-toggle {
            display: block; /* Show button on mobile */
        }
        .has-sidebar .main-content-wrapper {
            margin-left: 0; /* Override desktop margin */
            width: 100%;
        }
        .has-sidebar .sidebar {
            transform: translateX(-100%);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            width: 240px; /* Slightly narrower on mobile */
        }
        .has-sidebar .sidebar.active {
            transform: translateX(0);
        }
    }
    /* Ensure sidebar is visible on desktop if .has-sidebar is present */
    @media (min-width: 769px) {
        .has-sidebar .main-content-wrapper {
             margin-left: 260px; /* Restore margin */
             width: calc(100% - 260px);
        }
        .has-sidebar .mobile-menu-toggle {
            display: none; /* Hide toggle on desktop if sidebar is visible */
        }
        /* Sidebar is visible by default on desktop, no extra rules needed */
    }

    /* --- Scrollbar --- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--secondary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--muted-foreground); border-radius: 4px; border: 2px solid var(--secondary); }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* --- Specific Overrides & Page Styles --- */
    .welcome-heading { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--foreground); }
    .info-text { color: var(--muted-foreground); margin-bottom: 1.5rem; font-size: 1rem; }
    .current-prompt-display { /* Display box on update_prompt page */ padding: 1rem; background-color: var(--secondary); border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 0.5rem; /* Reduced margin */ overflow-wrap: break-word; font-size: 0.875rem; line-height: 1.5; color: var(--foreground); position: relative; }
    .current-prompt-display strong { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--foreground); }
    .current-prompt-display pre, .current-prompt-display span { /* Target the text container */ max-height: 150px; overflow-y: auto; display: block; /* Make span behave like block for scroll */ padding: 0.25rem; /* Inner padding */ }
    .current-prompt-display-area { margin-bottom: 1rem; } /* Wrapper div */
    #edit-current-prompt-btn { margin-top: 0.5rem; }
    hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }
    .form-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap; }

    /* --- Django Messages --- */
    .django-messages { position: fixed; top: 70px; right: 1rem; z-index: 1050; /* Above modals */ max-width: 350px; list-style: none; padding: 0; margin: 0; }
    .django-messages li { margin-bottom: 0.75rem; padding: 0.75rem 1.25rem; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 0.875rem; font-weight: 500; border-left: 4px solid; opacity: 0; transform: translateX(20px); animation: messageSlideInRight 0.5s forwards ease-out; background-color: var(--card); color: var(--card-foreground); border-color: var(--primary); }
    .dark .django-messages li { box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    @keyframes messageSlideInRight { to { opacity: 1; transform: translateX(0); } }
    .django-messages li.success { border-color: #10b981; }
    .django-messages li.info { border-color: #3b82f6; }
    .django-messages li.warning { border-color: #f59e0b; }
    .django-messages li.error { border-color: var(--destructive); }

    /* --- Prompt Edit Modal --- */
    .prompt-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; opacity: 0; transition: opacity 0.3s ease; }
    .prompt-modal-overlay.visible { display: flex; opacity: 1; }
    .prompt-modal-content { background-color: var(--card); color: var(--card-foreground); padding: 1.5rem 2rem 2rem; border-radius: var(--radius); max-width: 800px; width: 90%; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2); position: relative; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; }
    .prompt-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .prompt-modal-title { font-size: 1.25rem; font-weight: 600; }
    .prompt-modal-close-btn { background: none; border: none; font-size: 1.5rem; line-height: 1; cursor: pointer; color: var(--muted-foreground); padding: 0.25rem; }
    .prompt-modal-close-btn:hover { color: var(--foreground); }
    .prompt-modal-body { flex-grow: 1; overflow-y: auto; margin-bottom: 1.5rem; }
    #modal-prompt-textarea { width: 100%; min-height: 40vh; resize: vertical; font-family: monospace; font-size: 0.9rem; padding: 0.75rem; border-radius: var(--radius); border: 1px solid var(--input); background-color: var(--background); color: var(--foreground); }
    #modal-prompt-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
    .prompt-modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; flex-shrink: 0; }

    /* --- NEW: Privacy Consent Modal --- */
    .privacy-consent-overlay {
      position: fixed;
      inset: 0; /* top, right, bottom, left = 0 */
      background-color: rgba(0, 0, 0, 0.7); /* Darker overlay */
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 1040; /* Below Django messages, above other content */
      padding: 1rem;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .privacy-consent-overlay.visible {
      display: flex;
      opacity: 1;
    }
    .privacy-consent-modal {
      background-color: var(--card);
      color: var(--card-foreground);
      padding: 2rem;
      border-radius: var(--radius);
      max-width: 500px;
      width: 95%;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
      /* Simple fade-in effect */
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    .privacy-consent-overlay.visible .privacy-consent-modal {
       transform: scale(1);
       opacity: 1;
    }
    .privacy-consent-title {
      font-size: 1.25rem; /* text-xl */
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .privacy-consent-text {
      font-size: 0.9rem; /* Slightly smaller */
      color: var(--muted-foreground);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    .privacy-consent-text a {
       font-weight: 500;
       text-decoration: underline;
       text-underline-offset: 2px;
    }
     .privacy-consent-text a:hover {
       color: var(--primary-hover);
    }
    .privacy-consent-actions {
       margin-top: 1.5rem;
    }
    /* --- END: Privacy Consent Modal --- */
    
    {% block extra_css %}{% endblock %}
</style>
<script src="{% url 'javascript-catalog' %}"></script> 
</head>
{# ADD has-sidebar class if user is authenticated #}
<body class="{% if request.COOKIES.darkMode == 'true' %}dark{% endif %} {% if user.is_authenticated %}has-sidebar{% endif %}">

  <div class="layout">

    {# --- Conditionally render Sidebar, Toggle, and Overlay --- #}
    {% if user.is_authenticated %}
      <!-- Mobile Menu Toggle -->
      <button class="mobile-menu-toggle" aria-label="{% trans 'Toggle navigation menu' %}">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </button>
      <div class="overlay"></div>

      <!-- Sidebar -->
      <aside class="sidebar">
           <div class="sidebar-header">
              <a href="{% url 'home' %}" class="logo">
              <div class="logo-icon">SM</div>
              <span>{% trans "Social Manager" %}</span>
              </a>
          </div>

          <nav class="nav-items">
           {# --- Dashboard Link --- #}
           <a href="{% url 'home' %}" class="nav-item {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
            {# ... icon ... #} {% trans "Dashboard" %}
        </a>

        {# --- Inbox Link --- #}
        <a href="{% url 'inbox' %}" class="nav-item {% if request.resolver_match.url_name == 'inbox' or request.resolver_match.url_name == 'conversation_detail' %}active{% endif %}">
            {# ... icon ... #} {% trans "Inbox" %}
        </a>

        {# --- Connected Pages Link --- #}
        <a href="{% url 'connected_pages_list' %}" class="nav-item {% if request.resolver_match.url_name == 'connected_pages_list' or request.resolver_match.url_name == 'configure_page' %}active{% endif %}">
             <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
             {% trans "Connected Pages" %}
        </a>

        {# --- AI Prompt Link REMOVED --- #}
        {# <a href="{% url 'update_system_prompt' %}" ... > {% trans "AI Prompt" %} </a> #}

        {# --- Test AI Link --- #}
        <a href="{% url 'test_ai_conversation' %}" class="nav-item {% if request.resolver_match.url_name == 'test_ai_conversation' or request.resolver_match.url_name == 'send_test_message' %}active{% endif %}">
            {# ... icon ... #} {% trans "Test AI" %}
        </a>

        {# --- Privacy Policy Link --- #}
        <a class='nav-item {% if request.resolver_match.url_name == 'privacy_policy' %}active{% endif %}' href="{% url 'privacy_policy' %}">
             <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
             {% trans "Privacy Policy" %}
        </a>

        {# --- Connect Page Status Area (Simplified) --- #}
        <div class="nav-item" style="cursor: default;"> {# Not a link itself #}
            <i class="fab fa-facebook icon" style="stroke: none; fill: currentColor;"></i> {# Use FB icon #}
            {% trans "Page Status" %}
            {% if user.is_authenticated %}
                {% with connected_pages_count=user.connected_pages.count %}
                    {% if connected_pages_count > 0 %}
                        <span class="nav-status-indicator nav-status-ok" title="{% blocktrans count count=connected_pages_count %}{{ count }} page connected{% plural %}{{ count }} pages connected{% endblocktrans %}">
                            {% blocktrans count count=connected_pages_count %}{{ count }} Connected{% plural %}{{ count }} Connected{% endblocktrans %}
                        </span>
                    {% else %}
                         <a href="{% url 'meta_auth' %}" class="connect-link">{% trans "Connect" %}</a>
                    {% endif %}
                {% endwith %}
            {% else %}
                <span class="nav-status-indicator" title="{% trans 'Login to connect' %}">{% trans "N/A" %}</span>
            {% endif %}
        </div>

        {# --- Settings Link (Placeholder) --- #}
        {# <a href="#" class="nav-item"> ... {% trans "Settings" %} </a> #}
          </nav>

          <div class="sidebar-footer">
              <div class="user-profile">
                  <div class="avatar">
                      {# Display initials or user image #}
                      {{ request.user.username|slice:":2"|upper }}
                  </div>
                  <div class="user-info">
                      <div class="user-name">{{ request.user.get_full_name|default:request.user.username }}</div>
                      <div class="user-email">{{ request.user.email|default:"" }}</div>
                  </div>
                  <form method="post" action="{% url 'account_logout' %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="logout-button" title="{% trans 'Log out' %}">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                          <polyline points="16 17 21 12 16 7"></polyline>
                          <line x1="21" y1="12" x2="9" y2="12"></line>
                          </svg>
                      </button>
                  </form>
              </div>
          </div>
      </aside>
    {% else %}
       {# If user is not authenticated, the sidebar, toggle, and overlay are simply not rendered #}
        {% comment %} <div class="sidebar-footer" style="position: fixed; bottom: 1rem; left: 1rem; z-index: 50; padding: 1rem; border-top: 1px solid var(--border); background: var(--card); border-radius: var(--radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
           {# Show Login button fixed at bottom-left if logged out #}
            <div class="text-center">
                <a href="{% url 'account_login' %}" class="button button-primary w-full">{% trans "Sign In" %}</a>
            </div>
        </div> {% endcomment %}
    {% endif %}
    {# --- END Conditional Sidebar --- #}

    <!-- Main Content Wrapper -->
    <div class="main-content-wrapper">
        <header class="main-header">
            <div class="page-title">{% block header_title %}{% endblock %}</div>

            <div class="header-controls">
                {# --- Language Switcher --- #}
                {% get_current_language as CURRENT_LANGUAGE_CODE %}
                {% get_available_languages as AVAILABLE_LANGUAGES %}
                {% get_language_info_list for AVAILABLE_LANGUAGES as languages %}

                {% if languages|length > 1 %}
                <div class="language-switcher">
                    <button type="button" id="language-toggle-btn" class="button" aria-haspopup="true" aria-expanded="false" title="{% trans 'Change language' %}">
                        <span>{{ CURRENT_LANGUAGE_CODE|upper }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <ul id="language-dropdown" role="menu">
                        {% for language in languages %}
                        <li class="language-dropdown-item" role="presentation">
                            <button type="button" role="menuitem" data-lang-code="{{ language.code }}" class="{% if language.code == CURRENT_LANGUAGE_CODE %}active{% endif %}">
                                {{ language.name_local }} ({{ language.code|upper }})
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    <form id="language-form" action="{% url 'set_language' %}" method="post" style="display: none;">
                        {% csrf_token %}
                        <input name="next" type="hidden" value="{{ request.path }}">
                        <input type="hidden" name="language" id="language-input-hidden">
                    </form>
                </div>
                {% endif %}
                {# --- END Language Switcher --- #}

                {# Dark Mode Toggle #}
                <button id="theme-toggle" type="button" class="button button-ghost" title="{% trans 'Toggle theme' %}">
                    <svg id="theme-toggle-dark-icon" class="hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </header>

        {# Django Messages Area #}
        {% if messages %}
        <ul class="django-messages">
            {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        <main class="main-content">
          {% block content %}
            {# Default content goes here if not overridden #}
            <p>{% trans "Welcome to the application." %}</p>
          {% endblock %}
        </main>
    </div> {# End main-content-wrapper #}
  </div> {# End layout #}

  {# --- NEW: Privacy Consent Modal HTML --- #}
  <div id="privacy-consent-overlay" class="privacy-consent-overlay">
      <div id="privacy-consent-modal" class="privacy-consent-modal">
          <h2 class="privacy-consent-title">{% trans "Privacy & Cookie Consent" %}</h2>
          <p class="privacy-consent-text">
              {% blocktrans %}
              We use cookies and collect necessary data to operate this service and ensure its functionality. By continuing to use this site, you agree to our data practices described in the
              {% endblocktrans %}
              <a href="{% url 'privacy_policy' %}" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.
          </p>
          <div class="privacy-consent-actions">
              <button id="privacy-agree-btn" class="button button-primary">{% trans "Agree and Continue" %}</button>
          </div>
      </div>
  </div>
  {# --- END: Privacy Consent Modal HTML --- #}


  <script>
    // --- Get Cookie Function ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function() {
      // --- Element References ---
      const menuToggle = document.querySelector('.mobile-menu-toggle'); // Might be null if logged out
      const sidebar = document.querySelector('.sidebar'); // Might be null if logged out
      const overlay = document.querySelector('.overlay'); // Might be null if logged out
      const themeToggleButton = document.getElementById('theme-toggle');
      const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
      const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
      const langToggleButton = document.getElementById('language-toggle-btn');
      const langDropdown = document.getElementById('language-dropdown');
      const langForm = document.getElementById('language-form');
      const langHiddenInput = document.getElementById('language-input-hidden');
      const body = document.body;
      const privacyOverlay = document.getElementById('privacy-consent-overlay');
      const privacyAgreeBtn = document.getElementById('privacy-agree-btn');

      // --- Mobile Menu Toggle (Only if elements exist - i.e., logged in) ---
      if (menuToggle && sidebar && overlay) {
          function toggleMenu() {
            sidebar.classList.toggle('active');
            menuToggle.classList.toggle('active');
            overlay.classList.toggle('active');
            // body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
          }
          menuToggle.addEventListener('click', toggleMenu);
          overlay.addEventListener('click', toggleMenu);
      }

      // --- Theme Toggle ---
      if (themeToggleButton && themeToggleDarkIcon && themeToggleLightIcon) {
            const setTheme = (isDark) => {
                if (isDark) {
                    body.classList.add('dark');
                    themeToggleLightIcon.classList.remove('hidden');
                    themeToggleDarkIcon.classList.add('hidden');
                    themeToggleButton.setAttribute('title', '{% trans "Switch to light mode" %}');
                } else {
                    body.classList.remove('dark');
                    themeToggleDarkIcon.classList.remove('hidden');
                    themeToggleLightIcon.classList.add('hidden');
                    themeToggleButton.setAttribute('title', '{% trans "Switch to dark mode" %}');
                }
            };
            let initialIsDark;
            const darkModeCookie = getCookie('darkMode');
            if (darkModeCookie !== null) { initialIsDark = darkModeCookie === 'true'; }
            else { initialIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches; }
            setTheme(initialIsDark);

            themeToggleButton.addEventListener('click', () => {
                const isDarkNow = body.classList.toggle('dark');
                setTheme(isDarkNow);
                document.cookie = `darkMode=${isDarkNow};path=/;max-age=31536000;SameSite=Lax;Secure`;
            });
             window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                 if (getCookie('darkMode') === null) { setTheme(event.matches); }
            });
      }

      // --- Language Switcher Dropdown ---
      if (langToggleButton && langDropdown && langForm && langHiddenInput) {
          const toggleDropdown = (show) => {
              if (show) {
                  langDropdown.classList.add('visible');
                  langToggleButton.setAttribute('aria-expanded', 'true');
                  langToggleButton.classList.add('open');
              } else {
                  langDropdown.classList.remove('visible');
                  langToggleButton.setAttribute('aria-expanded', 'false');
                  langToggleButton.classList.remove('open');
              }
          };
          langToggleButton.addEventListener('click', (event) => {
              event.stopPropagation();
              toggleDropdown(!langDropdown.classList.contains('visible'));
          });
          langDropdown.addEventListener('click', (event) => {
              const targetButton = event.target.closest('.language-dropdown-item button');
              if (targetButton) {
                  const langCode = targetButton.getAttribute('data-lang-code');
                  if (langCode) {
                      langHiddenInput.value = langCode;
                      langForm.submit();
                  }
              }
          });
          document.addEventListener('click', (event) => {
              if (langDropdown.classList.contains('visible') && !langToggleButton.contains(event.target) && !langDropdown.contains(event.target)) {
                  toggleDropdown(false);
              }
          });
          document.addEventListener('keydown', (event) => {
              if (event.key === 'Escape' && langDropdown.classList.contains('visible')) {
                  toggleDropdown(false);
              }
          });
      }

      // --- Django Messages Auto-hide ---
      const messages = document.querySelectorAll('.django-messages li');
      messages.forEach((message, index) => {
          setTimeout(() => {
              message.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
              message.style.opacity = '0';
              message.style.transform = 'translateX(30px)';
              setTimeout(() => { if (message.parentNode) message.remove(); }, 500);
          }, 5000 + index * 300);
      });

      // --- NEW: Privacy Consent Logic ---
      if (privacyOverlay && privacyAgreeBtn) {
          const consentGiven = localStorage.getItem('privacyConsentGiven');
          // Only show if user is logged in AND consent not given
          // (Don't bother logged-out users who can't use the main features yet)
          {% if user.is_authenticated %}
              if (consentGiven !== 'true') {
                  privacyOverlay.classList.add('visible');
              }
          {% endif %}

          privacyAgreeBtn.addEventListener('click', () => {
              localStorage.setItem('privacyConsentGiven', 'true');
              privacyOverlay.classList.remove('visible');
              // Optionally add a small delay before fully hiding if needed for transition
              // setTimeout(() => { privacyOverlay.style.display = 'none'; }, 300);
          });
      }
      // --- END: Privacy Consent Logic ---

    }); // end DOMContentLoaded
  </script>
  {% block scripts_extra %}{% endblock %}

</body>
</html>