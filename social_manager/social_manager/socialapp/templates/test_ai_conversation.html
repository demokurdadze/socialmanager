{% extends "base_generic.html" %}
{% load static i18n %}

{% block title %}{% trans "Test AI Conversation" %}{% endblock title %}
{% block header_title %}{% trans "Test AI Conversation" %}{% endblock header_title %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">{% trans "Test Your AI Assistant" %}</h2>
        <p class="card-description">
            {% trans "Select a connected page, interact with its configured AI, and see how it responds." %}
        </p>
    </div>

    <div class="card-content">
        {% if not connected_pages %}
            <p class="text-center muted">{% trans "You need to connect at least one active page to test the AI." %}</p>
            <div class="text-center mt-4">
               <a href="{% url 'connected_pages_list' %}" class="button button-primary">{% trans "Connect or Manage Pages" %}</a>
            </div>
        {% else %}
            {# Page Selection Dropdown #}
            <div class="page-selection-area" style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                <label for="page-select" style="margin-bottom: 0; font-weight: 500;">{% trans "Test AI for Page:" %}</label>
                <select id="page-select" class="form-input" style="max-width: 300px;">
                    <option value="">{% trans "--- Select a Page ---" %}</option>
                    {% for page in connected_pages %}
                        <option value="{{ page.pk }}" data-prompt="{{ page.system_prompt|default:""|escape }}">
                            {{ page.page_name }} (ID: {{ page.page_id }})
                        </option>
                    {% endfor %}
                </select>
                <a href="#" id="view-prompt-link" class="button button-ghost button-sm hidden" style="text-decoration: none;">
                    <i class="fas fa-eye" style="margin-right: 0.3em;"></i> {% trans "View Prompt" %}
                </a>
            </div>

            {# Chat UI - Initially hidden until page selected? Or show default message #}
            <div class="chat-container" id="chat-ui" style="/* display: none; */"> {# Control visibility via JS #}
                <div class="system-prompt-info">
                    <strong>{% trans "Using System Prompt For:" %} <span id="selected-page-name">{% trans "No page selected" %}</span></strong>
                    <pre id="system-prompt-display" style="white-space: pre-wrap;">{% trans "(Select a page above to see its prompt)" %}</pre>
                    <a href="#" id="configure-prompt-link" class="hidden" style="font-size: 0.8rem;">
                       {% trans "Configure this prompt" %}
                    </a>
                </div>

                <div id="chatbox" class="chatbox">
                    <!-- Initial message -->
                    <div class="message ai-message">
                        <strong>{% trans "AI" %}:</strong>
                        <span>{% trans "Please select a page above to begin testing." %}</span>
                    </div>
                </div>

                <div id="error-display" class="error-display hidden" style="padding: 0.75rem 1rem; background-color: var(--destructive); color: var(--destructive-foreground); font-size: 0.875rem; text-align: center;"></div>
                {# Error messages will appear here #}

                <div id="input-area" class="input-area">
                    <textarea id="message-input" class="form-input" placeholder="{% trans 'Type your message here...' %}" autocomplete="off" rows="1" style="min-height: 40px; resize: vertical;" disabled></textarea>
                    <button id="send-button" class="button button-primary" title="{% trans 'Send Message' %}" disabled>
                        {% trans "Send" %}
                    </button>
                </div>
            </div>

            {# Modal for Viewing Prompt #}
            <div id="prompt-modal-overlay" class="prompt-modal-overlay">
                 <div id="prompt-modal-content" class="prompt-modal-content">
                    <div class="prompt-modal-header">
                        <h3 id="modal-prompt-title" class="prompt-modal-title">{% trans "System Prompt" %}</h3>
                        <button id="prompt-modal-close-btn" class="prompt-modal-close-btn" aria-label="{% trans 'Close' %}">Ã—</button>
                    </div>
                    <div class="prompt-modal-body">
                         <pre id="modal-prompt-text" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem;"></pre>
                    </div>
                    <div class="prompt-modal-footer">
                        <button id="prompt-modal-close-btn-footer" class="button button-secondary">{% trans "Close" %}</button>
                         <a href="#" id="modal-configure-link" class="button button-primary hidden">{% trans "Configure Prompt" %}</a>
                    </div>
                </div>
            </div>

        {% endif %} {# End if connected_pages exist #}
    </div> {# End card-content #}
</div> {# End card #}
{% endblock %}

{% block scripts_extra %}
<script>
  // Wrap everything in a try...catch for easier debugging if needed
  try {
    document.addEventListener('DOMContentLoaded', function () {
      const pageSelect = document.getElementById('page-select');
      const chatUI = document.getElementById('chat-ui');
      const chatbox = document.getElementById('chatbox');
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const errorDisplay = document.getElementById('error-display');
      const systemPromptDisplay = document.getElementById('system-prompt-display');
      const selectedPageNameSpan = document.getElementById('selected-page-name');
      const viewPromptLink = document.getElementById('view-prompt-link');
      const configurePromptLink = document.getElementById('configure-prompt-link');

      // Prompt Modal Elements
      const promptModalOverlay = document.getElementById('prompt-modal-overlay');
      const promptModalContent = document.getElementById('prompt-modal-content'); // Ensure this ID exists
      const promptModalTitle = document.getElementById('modal-prompt-title');
      const promptModalText = document.getElementById('modal-prompt-text');
      const promptModalCloseBtn = document.getElementById('prompt-modal-close-btn');
      const promptModalCloseBtnFooter = document.getElementById('prompt-modal-close-btn-footer');
      const modalConfigureLink = document.getElementById('modal-configure-link');

      const sendUrl = "{% url 'send_test_message' %}"; // URL for sending test messages via AJAX
      let selectedPagePk = null;
      let selectedPageName = '';
      // Base URL construction is now done inside the event listener

      // --- Page Selection Logic ---
      if (pageSelect) {
        pageSelect.addEventListener('change', function() {
          selectedPagePk = this.value;
          const selectedOption = this.options[this.selectedIndex];

          if (selectedPagePk && selectedOption) { // Check if selectedOption exists
            selectedPageName = selectedOption.text.split(' (ID:')[0]; // Extract name cleanly
            const prompt = selectedOption.getAttribute('data-prompt') || gettext("(No prompt set - using default)");

            // --- CORRECTED URL BUILDING ---
            // Construct the URL path directly based on known structure and selected PK
            const configureUrl = `/pages/${selectedPagePk}/configure/`;
            // --- END CORRECTION ---

            // Update UI elements
            selectedPageNameSpan.textContent = selectedPageName;
            systemPromptDisplay.textContent = prompt;
            chatUI.style.display = 'block'; // Show chat area
            messageInput.disabled = false; // Enable input
            sendButton.disabled = false; // Enable send button

            // Update link hrefs safely
            if (configurePromptLink) {
                configurePromptLink.href = configureUrl;
                configurePromptLink.classList.remove('hidden');
            }
            if (viewPromptLink) {
                viewPromptLink.classList.remove('hidden');
            }
            if (modalConfigureLink) {
                 modalConfigureLink.href = configureUrl;
                 modalConfigureLink.classList.remove('hidden');
            }


            // Clear chatbox and add initial message for the selected page
            chatbox.innerHTML = `
              <div class="message ai-message">
                <strong>${ gettext("AI") }:</strong>
                <span>${ interpolate(gettext("Hello! I'm ready to test using the prompt for '%s'. Type your message below."), [selectedPageName]) }</span>
              </div>`;
            hideError();
            if(messageInput) messageInput.focus(); // Focus input field

          } else {
            // Reset UI if no page is selected (e.g., selecting "--- Select a Page ---")
            selectedPagePk = null;
            selectedPageName = '';
            selectedPageNameSpan.textContent = gettext("No page selected");
            systemPromptDisplay.textContent = gettext("(Select a page above to see its prompt)");
            if(messageInput) messageInput.disabled = true; // Disable input
            if(sendButton) sendButton.disabled = true; // Disable send button

            // Hide related links
            if (configurePromptLink) configurePromptLink.classList.add('hidden');
            if (viewPromptLink) viewPromptLink.classList.add('hidden');
            if (modalConfigureLink) modalConfigureLink.classList.add('hidden');

            // Reset chatbox
            chatbox.innerHTML = `
              <div class="message ai-message">
                <strong>${ gettext("AI") }:</strong>
                <span>${ gettext("Please select a page above to begin testing.") }</span>
              </div>`;
            hideError();
          }
        });
      } else {
          console.warn("Page select dropdown ('page-select') not found.");
      }

      // --- Prompt Modal Logic ---
      function showPromptModal() {
          if (!selectedPagePk || !pageSelect) return; // Don't show if no page selected
          const selectedOption = pageSelect.options[pageSelect.selectedIndex];
          if (!selectedOption) return; // Safety check

          const prompt = selectedOption.getAttribute('data-prompt') || gettext("(No prompt set - using default)");
          if (promptModalTitle) promptModalTitle.textContent = interpolate(gettext("System Prompt for %s"), [selectedPageName]);
          if (promptModalText) promptModalText.textContent = prompt; // Display raw prompt text
          if (promptModalOverlay) promptModalOverlay.classList.add('visible'); // Show the modal
      }

      function closePromptModal() {
          if (promptModalOverlay) promptModalOverlay.classList.remove('visible'); // Hide the modal
      }

      // Add event listeners only if elements exist
      if (viewPromptLink) viewPromptLink.addEventListener('click', (e) => { e.preventDefault(); showPromptModal(); });
      if (promptModalOverlay) promptModalOverlay.addEventListener('click', (e) => { if (e.target === promptModalOverlay) closePromptModal(); }); // Close on overlay click
      if (promptModalCloseBtn) promptModalCloseBtn.addEventListener('click', closePromptModal);
      if (promptModalCloseBtnFooter) promptModalCloseBtnFooter.addEventListener('click', closePromptModal);


      // --- Chat Message Functions ---
      function addMessage(sender, text, messageType = "ai") {
        if (!chatbox) return;
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", `${messageType}-message`); // Combine classes

        const senderStrong = document.createElement("strong");
        senderStrong.textContent = sender + ":";
        messageDiv.appendChild(senderStrong);

        const textSpan = document.createElement("span");
        // Basic sanitization (replace < and > to prevent HTML injection)
        const safeText = text.replace(/</g, "<").replace(/>/g, ">");
        // Render newlines as <br>
        textSpan.innerHTML = safeText.split('\n').join('<br>');
        messageDiv.appendChild(textSpan);

        chatbox.appendChild(messageDiv);
        // Scroll to bottom smoothly
        chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: "smooth" });
      }

      function showError(message) {
        if (!errorDisplay) return;
        errorDisplay.textContent = `${gettext("Error")}: ${message}`;
        errorDisplay.classList.remove('hidden');
        if (chatbox) chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: "smooth" });
      }

      function hideError() {
        if (errorDisplay) {
            errorDisplay.classList.add('hidden');
            errorDisplay.textContent = "";
        }
      }

      // --- Send Message Logic ---
      async function sendMessage() {
        if (!messageInput || !sendButton) return; // Check elements exist
        const messageText = messageInput.value.trim();
        if (!messageText || !selectedPagePk) return; // Check message and page selection

        addMessage(gettext("You"), messageText, "user");
        messageInput.value = ""; // Clear input
        messageInput.disabled = true;
        sendButton.disabled = true;
        sendButton.textContent = gettext("Sending...");
        hideError(); // Hide previous errors

        try {
          const csrfToken = getCookie("csrftoken");
          if (!csrfToken) throw new Error(gettext("CSRF token not found. Please refresh the page."));

          const response = await fetch(sendUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({
                message: messageText,
                page_pk: selectedPagePk // Send selected page PK
            }),
          });

          // Always try to parse JSON, but prioritize response.ok check
          let data;
          try {
              data = await response.json();
          } catch (jsonError) {
              // Handle cases where the response is not valid JSON
              console.error("Failed to parse server response as JSON:", jsonError);
              throw new Error(`${gettext("Server Error")}: ${response.status} - Invalid response format.`);
          }


          if (!response.ok) {
            // Use error from JSON if available, otherwise use status
            throw new Error(data?.error || `${gettext("Server Error")}: ${response.status}`);
          }

          // Process successful response
          if (data.response) {
            addMessage(gettext("AI"), data.response, "ai");
          } else if (data.error) { // Check error even on 2xx (shouldn't happen ideally)
            throw new Error(data.error);
          } else {
            // Should not happen if response.ok is true and no error in JSON
            throw new Error(gettext("Received an unexpected successful response format."));
          }
        } catch (error) {
          console.error("Failed to send message:", error);
          const displayError = error.message || gettext("An unknown error occurred.");
          showError(displayError);
          // Optionally add a system message in chat about the failure
          addMessage(gettext("System"), `${ gettext("Failed to get response") }: ${displayError}`, "system");
        } finally {
          // Re-enable input fields
          messageInput.disabled = false;
          sendButton.disabled = false;
          sendButton.textContent = gettext("Send");
          messageInput.focus(); // Focus back on input
          autoResizeTextarea(messageInput); // Resize textarea after sending
        }
      }

      // Auto-resize Textarea Function
      function autoResizeTextarea(textarea) {
          if (!textarea) return;
          textarea.style.height = 'auto'; // Reset height to calculate scrollHeight correctly
          const maxHeight = 150; // Define max height in pixels
          const newHeight = Math.min(textarea.scrollHeight, maxHeight);
          // Apply new height, adding a small buffer might be needed depending on box-sizing
          textarea.style.height = newHeight + 'px';
      }

      // Add input listener for auto-resize if messageInput exists
      if (messageInput) {
          messageInput.addEventListener('input', () => autoResizeTextarea(messageInput));
      }


      // Add Event Listeners for sending message
      if (sendButton) sendButton.addEventListener("click", sendMessage);
      if (messageInput) {
        messageInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) { // Send on Enter (not Shift+Enter)
            e.preventDefault(); // Prevent default newline insertion
            sendMessage();
          }
        });
      }

      // --- Utility Functions ---
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
       }

      // Simple string interpolation helper (replace %s) - Django i18n format
      function interpolate(format, args) {
          let i = 0;
          // Replace %s placeholders with arguments
          return format.replace(/%s/g, function() {
              return args[i++];
          });
      }

       // --- Initial State Setup ---
       // Ensure input/button are disabled if no page selected initially or if select element is missing
       if (!pageSelect || !pageSelect.value) {
           if (messageInput) messageInput.disabled = true;
           if (sendButton) sendButton.disabled = true;
       } else {
           // If a page IS selected on load (e.g., browser back button persistence), trigger change handler
           pageSelect.dispatchEvent(new Event('change'));
       }

       // Auto-resize textarea on initial load (if messageInput exists)
       if(messageInput) autoResizeTextarea(messageInput);

    }); // End DOMContentLoaded
  } catch (err) {
    console.error("Error executing JavaScript in test_ai_conversation.html:", err);
    // Optionally display a user-friendly message on the page itself
  }
</script>
{% endblock %}