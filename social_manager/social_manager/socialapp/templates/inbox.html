{% extends "base_generic.html" %}
{% load i18n static humanize %}

{% block title %}{% trans "Inbox" %}{% endblock title %}
{% block header_title %}{% trans "Conversations Inbox" %}{% endblock header_title %}

{% block content %}
  {% if not pages_with_convos %}
      <div class="card">
          <div class="card-content text-center muted">
              <p>{% trans "No pages connected or no conversations yet." %}</p>
              <a href="{% url 'connected_pages_list' %}" class="button button-primary mt-4">{% trans "Connect or Manage Pages" %}</a>
          </div>
      </div>
  {% else %}
      {% for page in pages_with_convos %}
          <div class="card page-conversation-group {% if not page.recent_conversations %}empty{% endif %}">
              <div class="card-header page-header">
                  <div style="display: flex; align-items: center; gap: 0.75rem;">
                       <i class="fab fa-facebook-square" style="font-size: 1.5rem; color: #1877F2;"></i>
                       <h2 class="card-title page-title">{{ page.page_name }}</h2>
                  </div>
                   <a href="{% url 'configure_page' page.pk %}" class="button button-ghost button-sm" title="{% trans 'Configure AI for this page' %}">
                       <i class="fas fa-cog"></i> {% trans "Configure" %}
                   </a>
              </div>
              <div class="card-content">
                  {% if page.recent_conversations %}
                      <ul class="conversation-list">
                          {% for convo in page.recent_conversations %}
                              <li class="conversation-item">
                                  {# --- Link URL Updated --- #}
                                  <a href="{% url 'conversation_detail' connected_page_pk=page.pk sender_id=convo.sender_id %}" class="conversation-link">
                                      <div class="conversation-info">
                                          {# Maybe add avatar placeholder later #}
                                          <div class="sender-details">
                                              <span class="sender-id">{{ convo.sender_name }}</span> {# Use property/method #}
                                              <span class="last-message-preview">
                                                  {{ convo.get_last_message_text|default:_("(No text messages yet)")|truncatechars:80 }}
                                              </span>
                                          </div>
                                      </div>
                                      <div class="conversation-meta">
                                          <span class="last-updated" title="{{ convo.last_updated|date:'Y-m-d H:i:s T' }}">
                                              {{ convo.last_updated|naturaltime }}
                                          </span>
                                      </div>
                                  </a>
                                  {# --- Delete Form URL Updated --- #}
                                  <form method="post" action="{% url 'delete_conversation' connected_page_pk=page.pk sender_id=convo.sender_id %}" class="delete-conversation-form" onsubmit="return confirm('{% trans "Are you sure you want to delete this chat history from the system? This cannot be undone." %}');">
                                      {% csrf_token %}
                                      <button type="submit" class="button button-destructive button-sm button-icon" title="{% trans 'Delete History' %}">
                                          <i class="fas fa-trash-alt"></i>
                                      </button>
                                  </form>
                              </li>
                          {% endfor %}
                      </ul>
                  {% else %}
                      <p class="text-center muted">{% trans "No conversations for this page yet." %}</p>
                  {% endif %}
              </div>
          </div> {# End Card #}
      {% endfor %}
  {% endif %}

<style>
  .page-conversation-group { margin-bottom: 2rem; }
  .page-header { display: flex; justify-content: space-between; align-items: center; background-color: var(--secondary); padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border); margin-bottom: 0; }
  .page-title { font-size: 1.1rem; margin-bottom: 0; }
  .page-conversation-group.empty .card-content { padding-top: 1rem; padding-bottom: 1rem; }

  /* Conversation list styles from previous response */
  .conversation-list { list-style: none; padding: 0; margin: 0; }
  .conversation-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); transition: background-color 0.2s ease; }
  .conversation-item:last-child { border-bottom: none; }
  .conversation-item:hover { background-color: var(--secondary-hover); }
  .conversation-link { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; text-decoration: none; color: inherit; padding: 0.8rem 1rem; margin-right: 0.5rem;}
  .conversation-info { display: flex; align-items: center; flex-grow: 1; overflow: hidden; }
  .sender-details { display: flex; flex-direction: column; overflow: hidden; }
  .sender-id { font-weight: 600; margin-bottom: 0.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .last-message-preview { font-size: 0.9em; color: var(--muted-foreground); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .conversation-meta { display: flex; flex-direction: column; align-items: flex-end; font-size: 0.8em; color: var(--muted-foreground); white-space: nowrap; flex-shrink: 0; margin-left: 1rem; text-align: right;}
  .last-updated { margin-bottom: 0.2em; }
  .delete-conversation-form { padding-right: 0.8rem; flex-shrink: 0;}
  .delete-conversation-form button { background: none; border: none; cursor: pointer; padding: 0.3rem 0.5rem; line-height: 1;}
  .button-icon i { margin: 0; vertical-align: middle;}
</style>
{% endblock content %}