# File path: .github/workflows/deploy.yml

name: Deploy Social Manager

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install Django python-dotenv
        fi
    
    - name: Create hosting files
      run: |
        # Create necessary files
        echo '<IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(.*)$ /passenger_wsgi.py/$1 [QSA,L]
        </IfModule>' > .htaccess
        
        # Create passenger_wsgi.py if it doesn't exist
        if [ ! -f passenger_wsgi.py ]; then
          echo 'import os
          import sys
          
          path = os.path.dirname(os.path.abspath(__file__))
          if path not in sys.path:
              sys.path.append(path)
          
          os.environ.setdefault("DJANGO_SETTINGS_MODULE", "social_manager.settings")
          
          from django.core.wsgi import get_wsgi_application
          application = get_wsgi_application()' > passenger_wsgi.py
        fi
    
    # Using a different FTP deployment action
    - name: Deploy with FTPS
      uses: milanmk/actions-file-deployer@master
      with:
        remote-protocol: ftps
        remote-host: ${{ secrets.FTP_SERVER }}
        remote-user: ${{ secrets.FTP_USERNAME }}
        remote-password: ${{ secrets.FTP_PASSWORD }}
        remote-path: /
